<script>
	// Cache for available papers
	let availablePapers = [];
	const PAST_PAPERS_DIR = "past_papers/";

	// Function to load the papers index
	async function loadPapersIndex() {
		if (availablePapers.length > 0) {
			return availablePapers; // Already loaded
		}

		try {
			// Try to load index.json from root directory first (where it actually exists)
			const rootResponse = await fetch("index.json");
			if (rootResponse.ok) {
				const index = await rootResponse.json();
				if (Array.isArray(index)) {
					availablePapers = index.map((file) =>
						file.startsWith(PAST_PAPERS_DIR) ? file : `${PAST_PAPERS_DIR}${file}`
					);
				} else if (index.papers && Array.isArray(index.papers)) {
					availablePapers = index.papers.map((file) =>
						file.startsWith(PAST_PAPERS_DIR) ? file : `${PAST_PAPERS_DIR}${file}`
					);
				}
			} else {
				// Fallback: try past_papers directory (in case it exists there)
				const indexPath = `${PAST_PAPERS_DIR}index.json`;
				const response = await fetch(indexPath);
				if (response.ok) {
					const index = await response.json();
					if (Array.isArray(index)) {
						availablePapers = index.map((file) =>
							file.startsWith(PAST_PAPERS_DIR) ? file : `${PAST_PAPERS_DIR}${file}`
						);
					} else if (index.papers && Array.isArray(index.papers)) {
						availablePapers = index.papers.map((file) =>
							file.startsWith(PAST_PAPERS_DIR) ? file : `${PAST_PAPERS_DIR}${file}`
						);
					}
				} else {
					throw new Error("No index.json found");
				}
			}

			console.log(`Loaded ${availablePapers.length} papers from index`);
			return availablePapers;
		} catch (error) {
			console.error("Error loading papers index:", error);
			// Fallback: try pattern-based discovery
			return await discoverPapersByPattern();
		}
	}

	// Fallback: discover papers by trying common patterns
	async function discoverPapersByPattern() {
		const discovered = [];
		const promises = [];

		// Try papers from 001 to 100
		for (let i = 1; i <= 100; i++) {
			const num = i.toString().padStart(3, "0");
			const filename = `${PAST_PAPERS_DIR}a1_paper_${num}.json`;

			promises.push(
				fetch(filename, { method: "HEAD" })
					.then((response) => {
						if (response.ok) {
							discovered.push(filename);
						}
					})
					.catch(() => {})
			);
		}

		await Promise.allSettled(promises);
		availablePapers = discovered.sort();
		console.log(`Discovered ${availablePapers.length} papers by pattern`);
		return availablePapers;
	}

	// Function to get a random paper filename
	function getRandomPaper() {
		if (availablePapers.length === 0) {
			return `${PAST_PAPERS_DIR}a1_paper_001.json`; // fallback
		}
		const randomIndex = Math.floor(Math.random() * availablePapers.length);
		return availablePapers[randomIndex];
	}

	// Cache for available images
	let availableImages = [];

	// Function to load images index
	async function loadImagesIndex() {
		if (availableImages.length > 0) {
			return availableImages; // Already loaded
		}

		const IMAGES_DIR = "past_papers_images/";

		try {
			// Try to load index.json from images directory
			const indexPath = `${IMAGES_DIR}index.json`;
			const response = await fetch(indexPath);
			if (response.ok) {
				const index = await response.json();
				if (Array.isArray(index)) {
					availableImages = index.map((file) =>
						file.endsWith(".png") ? `${IMAGES_DIR}${file}` : `${IMAGES_DIR}${file}.png`
					);
				} else if (index.images && Array.isArray(index.images)) {
					availableImages = index.images.map((file) =>
						file.endsWith(".png") ? `${IMAGES_DIR}${file}` : `${IMAGES_DIR}${file}.png`
					);
				}
				console.log(`Loaded ${availableImages.length} images from index`);
				return availableImages;
			}
		} catch (error) {
			console.log("No images index.json found, will discover images");
		}

		// Fallback: discover images by trying common patterns
		return await discoverImagesByPattern();
	}

	// Fallback: discover images by trying common patterns
	async function discoverImagesByPattern() {
		const IMAGES_DIR = "past_papers_images/";
		const discovered = [];
		const promises = [];

		// Try common naming patterns
		const patterns = [
			// Try numbered patterns: image_01.png, image_1.png, img_01.png, etc.
			...Array.from({ length: 20 }, (_, i) => {
				const num = (i + 1).toString().padStart(2, "0");
				return [
					`${IMAGES_DIR}image_${num}.png`,
					`${IMAGES_DIR}img_${num}.png`,
					`${IMAGES_DIR}${num}.png`,
				];
			}).flat(),
			// Try single digits
			...Array.from({ length: 10 }, (_, i) => `${IMAGES_DIR}image_${i + 1}.png`),
		];

		// Remove duplicates
		const uniquePatterns = [...new Set(patterns)];

		for (const filename of uniquePatterns) {
			promises.push(
				fetch(filename, { method: "HEAD" })
					.then((response) => {
						if (response.ok) {
							discovered.push(filename);
						}
					})
					.catch(() => {})
			);
		}

		await Promise.allSettled(promises);
		availableImages = discovered.sort();
		console.log(`Discovered ${availableImages.length} images by pattern`);
		return availableImages;
	}

	// Function to get a random image from past_papers_images directory
	async function getRandomImage() {
		// Ensure images are loaded
		if (availableImages.length === 0) {
			await loadImagesIndex();
		}

		if (availableImages.length === 0) {
			// No images found, return null to hide the image section
			return null;
		}

		const randomIndex = Math.floor(Math.random() * availableImages.length);
		return availableImages[randomIndex];
	}

	// Timer functionality (defined early so it can be used by loadPaper)
	const timers = {
		personal: { interval: null, remaining: 90, total: 90, running: false },
		situations: { interval: null, remaining: 90, total: 90, running: false },
		image: { interval: null, remaining: 90, total: 90, running: false },
		listening: { interval: null, remaining: 120, total: 120, running: false },
		monologue: { interval: null, remaining: 120, total: 120, running: false },
	};

	function formatTime(seconds) {
		const mins = Math.floor(seconds / 60);
		const secs = seconds % 60;
		return `${mins}:${secs.toString().padStart(2, "0")}`;
	}

	function updateTimerDisplay(section) {
		const timer = timers[section];
		const display = document.getElementById(`timer-${section}`);
		const button = document.getElementById(`timer-btn-${section}`);
		if (display) {
			display.textContent = formatTime(timer.remaining);
			if (timer.running) {
				display.classList.add("timer-running");
			} else {
				display.classList.remove("timer-running");
			}
		}
		if (button) {
			button.textContent = timer.running ? "â¸" : "â–¶";
		}
	}

	function resetAllTimers() {
		Object.keys(timers).forEach((section) => {
			const timer = timers[section];
			if (timer.interval) {
				clearInterval(timer.interval);
			}
			timer.remaining = timer.total;
			timer.running = false;
			updateTimerDisplay(section);
		});
	}

	// Function to load a specific paper
	function loadPaper(filename) {
		// Reset all timers when loading new paper
		resetAllTimers();

		document.getElementById("content").innerHTML =
			'<p style="text-align: center; color: white; font-size: 1.2rem;">Loading content...</p>';

		fetch(filename)
			.then((response) => {
				if (!response.ok) {
					throw new Error(`Failed to load ${filename}`);
				}
				return response.json();
			})
			.then((data) => {
				displayContent(data);
				document.getElementById("currentPaper").textContent = `Current: ${data.id || filename}`;
			})
			.catch((error) => {
				document.getElementById(
					"content"
				).innerHTML = `<p style="color: #ff6b6b; text-align: center;">Error loading ${filename}. Please ensure the file exists.</p>`;
				console.error("Error:", error);
				document.getElementById("currentPaper").textContent = "";
			});
	}

	// Function to load a random paper
	async function loadRandomPaper() {
		// Ensure papers are loaded
		if (availablePapers.length === 0) {
			document.getElementById("content").innerHTML =
				'<p style="text-align: center; color: white; font-size: 1.2rem;">Loading available papers...</p>';
			await loadPapersIndex();
		}

		const currentPaper = document.getElementById("currentPaper").textContent;
		let randomPaper;

		// If there's only one paper, just reload it
		if (availablePapers.length <= 1) {
			randomPaper = availablePapers[0] || `${PAST_PAPERS_DIR}a1_paper_001.json`;
		} else {
			// Get a different random paper (avoid loading the same one if possible)
			do {
				randomPaper = getRandomPaper();
			} while (
				availablePapers.length > 1 &&
				currentPaper.includes(randomPaper.replace(".json", "").replace(PAST_PAPERS_DIR, ""))
			);
		}

		// Scroll to top and load the paper
		window.scrollTo({ top: 0, behavior: "smooth" });
		loadPaper(randomPaper);
	}

	// Make function globally accessible
	window.loadRandomPaper = loadRandomPaper;

	// Load initial paper on page load
	(async function () {
		await loadPapersIndex();
		if (availablePapers.length > 0) {
			loadPaper(availablePapers[0]);
		} else {
			// Fallback if no papers found
			loadPaper(`${PAST_PAPERS_DIR}a1_paper_001.json`);
		}
	})();

	// Also attach event listener as backup (in addition to onclick)
	document.addEventListener("DOMContentLoaded", function () {
		const button = document.getElementById("randomButton");
		if (button) {
			button.addEventListener("click", function (e) {
				e.preventDefault();
				loadRandomPaper();
			});
		}
	});

	function displayContent(data) {
		const content = document.getElementById("content");
		let html = "";

		// Personal Information Section
		html += `
                <section class="section">
                    <h2>
                        <span class="arabic-text">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</span>
                        <span class="section-timestamp">
                            <button class="timer-button" onclick="toggleTimer('personal', 90)" id="timer-btn-personal">â–¶</button>
                            <span class="timer-display" id="timer-personal">1:30</span>
                        </span>
                    </h2>
                    <p class="section-subtitle arabic-text">Ø£Ø³Ø¦Ù„Ø© ØªÙ…Ù‡ÙŠØ¯ÙŠØ© ÙˆØ¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø´Ø­</p>
                    
                    <h3 class="subsection-title arabic-text">Ø£Ø³Ø¦Ù„Ø© ØªÙ…Ù‡ÙŠØ¯ÙŠØ©</h3>
                    <p class="subsection-subtitle arabic-text">Ø£Ø³Ø¦Ù„Ø© Ø¹Ø§Ù…Ø© Ø¹Ù†Ùƒ.</p>
                    ${data.personal_information.intro_questions
											.map(
												(q) => `
                        <div class="question-item">
                            <button class="tts-button" onclick="speakText('${q.text.replace(
															/'/g,
															"\\'"
														)}', this)" title="Read aloud">ğŸ”Š</button>
                            <p class="question-text">${q.text}</p>
                        </div>
                    `
											)
											.join("")}
                    
                    <h3 class="subsection-title arabic-text">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
                    <p class="subsection-subtitle arabic-text">Ø£Ø³Ø¦Ù„Ø© Ù…Ø­Ø¯Ø¯Ø© Ø¹Ù†ÙƒØŒ Ù‡ÙˆØ§ÙŠØ§ØªÙƒØŒ ØªÙØ¶ÙŠÙ„Ø§ØªÙƒØŒ Ø¥Ù„Ø®.</p>
                    ${data.personal_information.main_questions
											.map(
												(q) => `
                        <div class="question-item">
                            <button class="tts-button" onclick="speakText('${q.text.replace(
															/'/g,
															"\\'"
														)}', this)" title="Read aloud">ğŸ”Š</button>
                            <p class="question-text">${q.text}</p>
                        </div>
                    `
											)
											.join("")}
                </section>
            `;

		// Situations Section
		html += `
                <section class="section">
                    <h2>
                        <span class="arabic-text">Ø§Ù„Ù…ÙˆØ§Ù‚Ù</span>
                        <span class="section-timestamp">
                            <button class="timer-button" onclick="toggleTimer('situations', 90)" id="timer-btn-situations">â–¶</button>
                            <span class="timer-display" id="timer-situations">1:30</span>
                        </span>
                    </h2>
                    <p class="section-subtitle arabic-text">Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ù„Ù…Ø±Ø´Ø­ Ù„Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ø£Ùˆ Ø¨Ø¯Ø¦Ù‡Ø§</p>
                    
                    <h3 class="subsection-title arabic-text">Ù…ÙˆØ§Ù‚Ù Ø§Ù„Ø±Ø¯</h3>
                    <p class="subsection-subtitle arabic-text">ÙƒÙŠÙ ØªØ±Ø¯ ÙÙŠ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©ØŸ</p>
                    ${data.situations.respond_situations
											.map(
												(s) => `
                        <div class="situation-item">
                            <button class="tts-button" onclick="speakText('${(
															s.role_context +
															" " +
															s.starter_line
														).replace(/'/g, "\\'")}', this)" title="Read aloud">ğŸ”Š</button>
                            <div class="role-context">${s.role_context}</div>
                            <p class="starter-line">"${s.starter_line}"</p>
                        </div>
                    `
											)
											.join("")}
                    
                    <h3 class="subsection-title arabic-text">Ù…ÙˆØ§Ù‚Ù Ø§Ù„Ø³Ø¤Ø§Ù„</h3>
                    <p class="subsection-subtitle arabic-text">Ù…Ø§Ø°Ø§ ØªØ³Ø£Ù„ ÙÙŠ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©ØŸ</p>
                    ${data.situations.ask_situations
											.map(
												(s) => `
                        <div class="situation-item">
                            <button class="tts-button" onclick="speakText('${s.instruction.replace(
															/'/g,
															"\\'"
														)}', this)" title="Read aloud">ğŸ”Š</button>
                            <div class="role-context">${s.instruction}</div>
                            <p class="starter-line">...?</p>
                        </div>
                    `
											)
											.join("")}
                </section>
            `;

		// Image Section (Section 3)
		html += `
                <section class="section">
                    <h2>
                        <span class="arabic-text">Ø§Ù„ØµÙˆØ±Ø©</span>
                        <span class="section-timestamp">
                            <button class="timer-button" onclick="toggleTimer('image', 90)" id="timer-btn-image">â–¶</button>
                            <span class="timer-display" id="timer-image">1:30</span>
                        </span>
                    </h2>
                    <p class="section-subtitle arabic-text">Ø³ÙŠØ·Ø±Ø­ Ø§Ù„Ù…Ù…ØªØ­Ù† Ø£Ø³Ø¦Ù„Ø© Ø­ÙˆÙ„ Ø§Ù„ØµÙˆØ±Ø©ØŒ ÙˆÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø±Ø´Ø­ Ø£ÙŠØ¶Ø§Ù‹ Ø§Ù‚ØªØ±Ø§Ø­ Ø£Ø³Ø¦Ù„Ø©</p>
                    <div class="exam-image-container">
                        <img id="exam-image" src="" alt="Exam image" class="exam-image" />
                    </div>
                </section>
            `;

		// Listening Script Section (Section 4)
		html += `
                <section class="section">
                    <h2>
                        <span class="arabic-text">Ù†Øµ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹</span>
                        <span class="section-timestamp">
                            <button class="timer-button" onclick="toggleTimer('listening', 120)" id="timer-btn-listening">â–¶</button>
                            <span class="timer-display" id="timer-listening">2:00</span>
                        </span>
                    </h2>
                    <p class="section-subtitle arabic-text">Ù†Øµ Ù‚ØµÙŠØ± Ù…ØªØ¨ÙˆØ¹ Ø¨Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙÙ‡Ù…</p>
                    
                    <div class="listening-text" style="position: relative;">
                        <button class="tts-button" onclick="speakText('${data.listening_script.text.replace(
													/'/g,
													"\\'"
												)}', this)" title="Read aloud" style="position: absolute; top: 1rem; right: 1rem;">ğŸ”Š</button>
                        ${data.listening_script.text}
                    </div>
                    
                    <h3 class="subsection-title arabic-text">Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
                    <p class="subsection-subtitle arabic-text">Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø£Ø¹Ù„Ø§Ù‡.</p>
                    ${data.listening_script.questions
											.map(
												(q) => `
                        <div class="question-answer" style="position: relative;">
                            <button class="tts-button" onclick="speakText('${q.question.replace(
															/'/g,
															"\\'"
														)}', this)" title="Read aloud" style="position: absolute; top: 0.75rem; right: 0.75rem;">ğŸ”Š</button>
                            <p class="question-text">${q.question}</p>
                        </div>
                    `
											)
											.join("")}
                </section>
            `;

		// Monologue Section (Section 5)
		html += `
                <section class="section">
                    <h2>
                        <span class="arabic-text">Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ÙØ±Ø¯</span>
                        <span class="section-timestamp">
                            <button class="timer-button" onclick="toggleTimer('monologue', 120)" id="timer-btn-monologue">â–¶</button>
                            <span class="timer-display" id="timer-monologue">2:00</span>
                        </span>
                    </h2>
                    <p class="section-subtitle arabic-text">Ù…ÙˆØ¶ÙˆØ¹ Ù„Ù„Ù…Ø±Ø´Ø­ Ù„Ù„ØªØ­Ø¯Ø« Ø¹Ù†Ù‡ØŒ Ù…Ø¹ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø¨Ø¹Ø©</p>
                    
                    <div class="monologue-topic" style="position: relative;">
                        <button class="tts-button" onclick="speakText('${(
													data.monologue.topic + " for 30 seconds"
												).replace(
													/'/g,
													"\\'"
												)}', this)" title="Read aloud" style="position: absolute; top: 1rem; right: 1rem; background: rgba(255, 255, 255, 0.3); border-color: white;">ğŸ”Š</button>
                        ${data.monologue.topic} for 30 seconds
                    </div>
                    
                    <h3 class="subsection-title arabic-text">Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h3>
                    <p class="subsection-subtitle arabic-text">ÙƒÙ† Ù…Ø³ØªØ¹Ø¯Ù‹Ø§ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø­ÙˆÙ„ Ù…ÙˆØ¶ÙˆØ¹Ùƒ.</p>
                    ${data.monologue.follow_up_questions
											.map(
												(q) => `
                        <div class="question-item">
                            <button class="tts-button" onclick="speakText('${q.question.replace(
															/'/g,
															"\\'"
														)}')" title="Read aloud">ğŸ”Š</button>
                            <p class="question-text">${q.question}</p>
                        </div>
                    `
											)
											.join("")}
                </section>
            `;

		content.innerHTML = html;

		// Load random image after content is rendered
		getRandomImage()
			.then((imagePath) => {
				const imgElement = document.getElementById("exam-image");
				if (imgElement && imagePath) {
					imgElement.src = imagePath;
					// Remove error handler to prevent infinite retry loop
					// If image fails, it will just not display (better than spamming errors)
					imgElement.onerror = function () {
						// Hide the image container if image fails to load
						const container = this.closest(".exam-image-container");
						if (container) {
							container.style.display = "none";
						}
					};
				} else if (imgElement) {
					// No images found, hide the image container
					const container = imgElement.closest(".exam-image-container");
					if (container) {
						container.style.display = "none";
					}
				}
			})
			.catch((error) => {
				console.error("Error loading image:", error);
				const imgElement = document.getElementById("exam-image");
				if (imgElement) {
					const container = imgElement.closest(".exam-image-container");
					if (container) {
						container.style.display = "none";
					}
				}
			});
	}

	// TTS functionality using Web Speech API
	let currentUtterance = null;
	let currentButton = null;

	function speakText(text, buttonElement) {
		// Stop any currently playing speech
		if (window.speechSynthesis.speaking) {
			window.speechSynthesis.cancel();
			if (currentButton) {
				currentButton.classList.remove("playing");
			}
		}

		// Create new utterance
		const utterance = new SpeechSynthesisUtterance(text);

		// Configure voice settings for quality English TTS
		utterance.lang = "en-US";
		utterance.rate = 0.9; // Slightly slower for clarity
		utterance.pitch = 1;
		utterance.volume = 1;

		// Try to use a high-quality female voice if available
		function setVoice() {
			const voices = window.speechSynthesis.getVoices();

			// Prefer female voices - common female voice names
			const femaleVoiceNames = [
				"Samantha",
				"Victoria",
				"Karen",
				"Fiona",
				"Tessa",
				"Zira",
				"Hazel",
				"Susan",
				"Linda",
				"Female",
				"Google UK English Female",
				"Microsoft Zira",
			];

			// First try to find a preferred female voice
			const preferredFemaleVoices = voices.filter(
				(voice) =>
					voice.lang.startsWith("en") && femaleVoiceNames.some((name) => voice.name.includes(name))
			);

			if (preferredFemaleVoices.length > 0) {
				utterance.voice = preferredFemaleVoices[0];
			} else {
				// Try any female voice (check if voice name suggests female)
				const anyFemaleVoices = voices.filter(
					(voice) =>
						voice.lang.startsWith("en") &&
						(voice.name.toLowerCase().includes("female") ||
							voice.name.toLowerCase().includes("samantha") ||
							voice.name.toLowerCase().includes("zira") ||
							voice.name.toLowerCase().includes("victoria") ||
							voice.name.toLowerCase().includes("karen"))
				);

				if (anyFemaleVoices.length > 0) {
					utterance.voice = anyFemaleVoices[0];
				} else {
					// Fallback to any high-quality voice
					const preferredVoices = voices.filter(
						(voice) =>
							voice.lang.startsWith("en") &&
							(voice.name.includes("Google") ||
								voice.name.includes("Microsoft") ||
								voice.name.includes("Samantha") ||
								voice.name.includes("Alex"))
					);

					if (preferredVoices.length > 0) {
						utterance.voice = preferredVoices[0];
					} else {
						// Final fallback to first English voice
						const englishVoices = voices.filter((voice) => voice.lang.startsWith("en"));
						if (englishVoices.length > 0) {
							utterance.voice = englishVoices[0];
						}
					}
				}
			}
		}

		// Set voice (may need to wait for voices to load)
		setVoice();
		if (window.speechSynthesis.getVoices().length === 0) {
			window.speechSynthesis.onvoiceschanged = setVoice;
		}

		// Get button element from event
		currentButton = buttonElement || (window.event ? window.event.target : null);

		// Add visual feedback
		if (currentButton) {
			currentButton.classList.add("playing");
		}

		// Handle speech end
		utterance.onend = function () {
			if (currentButton) {
				currentButton.classList.remove("playing");
			}
			currentUtterance = null;
			currentButton = null;
		};

		utterance.onerror = function () {
			if (currentButton) {
				currentButton.classList.remove("playing");
			}
			currentUtterance = null;
			currentButton = null;
		};

		currentUtterance = utterance;
		window.speechSynthesis.speak(utterance);
	}

	// Load voices when available (some browsers need this)
	if (window.speechSynthesis.onvoiceschanged !== undefined) {
		window.speechSynthesis.onvoiceschanged = function () {
			// Voices loaded
		};
	}

	function toggleTimer(section, totalSeconds) {
		const timer = timers[section];
		const button = event.target;

		if (timer.running) {
			// Pause
			clearInterval(timer.interval);
			timer.running = false;
			button.textContent = "â–¶";
			button.title = "Resume timer";
		} else {
			// Start/Resume
			timer.running = true;
			button.textContent = "â¸";
			button.title = "Pause timer";

			timer.interval = setInterval(() => {
				timer.remaining--;
				updateTimerDisplay(section);

				// Stop when reaching 0
				if (timer.remaining <= 0) {
					clearInterval(timer.interval);
					timer.running = false;
					timer.remaining = 0;
					button.textContent = "â–¶";
					button.title = "Start timer";
					updateTimerDisplay(section);

					// Optional: Play a sound or show notification
					if (window.speechSynthesis) {
						const utterance = new SpeechSynthesisUtterance("Time is up");
						utterance.volume = 0.5;
						window.speechSynthesis.speak(utterance);
					}
				}
			}, 1000);
		}

		updateTimerDisplay(section);
	}
</script>
