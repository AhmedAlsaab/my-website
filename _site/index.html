<!DOCTYPE html>
<html lang="en" data-theme="dark">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>الامتحان - A1 Language Certification Paper</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
		<link rel="icon" href="data:," />
		<style>
	:root {
		--primary: #4a90e2;
		--primary-hover: #357abd;
		--primary-focus: rgba(74, 144, 226, 0.125);
		--tts-padding: 3.5rem;
	}

	html {
		background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
		background-attachment: fixed;
		min-height: 100%;
	}

	body {
		background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
		background-attachment: fixed;
		position: relative;
		overflow-x: hidden;
		min-height: 100vh;
	}

	/* Sparkly effect */
	body::before {
		content: "";
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-image: radial-gradient(circle, rgba(255, 255, 255, 0.8) 1px, transparent 1px),
			radial-gradient(circle, rgba(255, 255, 255, 0.6) 1px, transparent 1px),
			radial-gradient(circle, rgba(255, 255, 255, 0.4) 2px, transparent 2px);
		background-size: 300px 300px, 200px 200px, 400px 400px;
		background-position: 0 0, 50px 50px, 100px 100px;
		animation: sparkle 20s linear infinite;
		pointer-events: none;
		z-index: 0;
	}

	@keyframes sparkle {
		0% {
			opacity: 0.3;
			transform: translateY(0);
		}
		50% {
			opacity: 0.6;
		}
		100% {
			opacity: 0.3;
			transform: translateY(-100px);
		}
	}

	.container {
		position: relative;
		z-index: 1;
		max-width: 1200px;
		margin: 0 auto;
		padding: 2rem 1rem;
	}

	header {
		text-align: center;
		margin-bottom: 3rem;
		padding: 2rem 0;
		overflow: visible;
	}

	.total-time {
		margin-top: 1rem;
		color: rgba(255, 255, 255, 0.9);
		font-size: clamp(1rem, 2vw, 1.2rem);
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		background: rgba(255, 255, 255, 0.1);
		padding: 0.5rem 1.5rem;
		border-radius: 0.5rem;
	}

	h1 {
		font-size: clamp(2.5rem, 5vw, 4rem);
		margin-bottom: 1rem;
		margin-top: 0;
		padding-bottom: 0.5rem;
		line-height: 1.2;
		background: linear-gradient(135deg, #ffffff 0%, #a0c4ff 100%);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		background-clip: text;
		font-weight: 700;
		overflow: visible;
		display: block;
	}

	.random-button {
		margin-top: 1.5rem;
		font-size: clamp(1rem, 2vw, 1.2rem);
		padding: 0.75rem 2rem;
		background: #ffffff;
		border: 2px solid #ffffff;
		color: #1e3c72;
		border-radius: 0.5rem;
		cursor: pointer;
		transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
		font-weight: 600;
	}

	.random-button:hover {
		transform: translateY(-2px);
		box-shadow: 0 5px 20px rgba(255, 255, 255, 0.5);
		background: #f0f7ff;
	}

	.random-button:active {
		transform: translateY(0);
	}

	.current-paper {
		color: rgba(255, 255, 255, 0.9);
		font-size: clamp(0.9rem, 1.5vw, 1.1rem);
		margin-top: 0.5rem;
	}

	.section {
		background: rgba(255, 255, 255, 0.95);
		border-radius: 1rem;
		padding: 2.5rem;
		margin-bottom: 2rem;
		box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
		backdrop-filter: blur(10px);
	}

	.section h2 {
		color: #1e3c72;
		font-size: clamp(1.8rem, 3vw, 2.5rem);
		margin-bottom: 0.5rem;
		border-bottom: 3px solid #4a90e2;
		padding-bottom: 0.5rem;
		display: flex;
		align-items: center;
		justify-content: space-between;
		flex-wrap: wrap;
		gap: 1rem;
	}

	.section-timestamp {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		background: rgba(74, 144, 226, 0.1);
		padding: 0.5rem 1rem;
		border-radius: 0.5rem;
		font-size: clamp(1rem, 2vw, 1.2rem);
		color: #1e3c72;
		font-weight: 600;
		white-space: nowrap;
	}

	.timer-button {
		background: transparent;
		border: none;
		padding: 0;
		font-size: clamp(1rem, 2vw, 1.2rem);
		cursor: pointer;
		transition: opacity 0.2s;
		color: #1e3c72;
		font-weight: 600;
		line-height: 1;
	}

	.timer-button:hover {
		opacity: 0.7;
	}

	.timer-display {
		font-size: clamp(1rem, 2vw, 1.2rem);
		min-width: 3.5rem;
		text-align: center;
	}

	.timer-running {
		color: #e65100;
	}

	.section-subtitle {
		color: #555;
		font-size: clamp(1rem, 2vw, 1.2rem);
		margin-bottom: 2rem;
		font-style: italic;
	}

	.arabic-text {
		direction: rtl;
		text-align: left;
		font-family: "Segoe UI", Tahoma, Arial, sans-serif;
	}

	.section h2 .arabic-text {
		direction: rtl;
		text-align: left;
	}

	.question-item,
	.situation-item {
		background: rgba(74, 144, 226, 0.08);
		padding: 1.5rem;
		padding-right: var(--tts-padding);
		margin-bottom: 1rem;
		border-radius: 0.5rem;
		border-left: 4px solid #4a90e2;
		position: relative;
	}

	.tts-button {
		position: absolute;
		top: 0.75rem;
		right: 0.75rem;
		background: rgba(74, 144, 226, 0.85);
		border: none;
		border-radius: 50%;
		width: 2rem;
		height: 2rem;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		transition: all 0.2s;
		font-size: 0.9rem;
		box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
		z-index: 10;
	}

	.tts-button:hover {
		background: rgba(74, 144, 226, 1);
		transform: scale(1.1);
		box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
	}

	.tts-button.playing {
		background: rgba(74, 144, 226, 1);
		animation: pulse 1.5s ease-in-out infinite;
	}

	.situation-item .tts-button {
		top: 1rem;
		right: 1rem;
	}

	@keyframes pulse {
		0%,
		100% {
			opacity: 1;
		}
		50% {
			opacity: 0.6;
		}
	}

	.question-text,
	.situation-text {
		font-size: clamp(1.1rem, 2vw, 1.3rem);
		color: #1a1a1a;
		margin: 0;
		font-weight: 500;
		word-wrap: break-word;
		overflow-wrap: break-word;
	}

	.subsection-title {
		color: #2a5298;
		font-size: clamp(1.3rem, 2.5vw, 1.6rem);
		margin-top: 2rem;
		margin-bottom: 0.5rem;
		font-weight: 600;
	}

	.subsection-subtitle {
		color: #666;
		font-size: clamp(0.9rem, 1.8vw, 1.1rem);
		margin-bottom: 1.5rem;
		font-style: italic;
	}

	.listening-text {
		background: #f0f7ff;
		padding: 2rem;
		padding-right: var(--tts-padding);
		border-radius: 0.5rem;
		font-size: clamp(1.1rem, 2vw, 1.3rem);
		line-height: 1.8;
		color: #1a1a1a;
		margin-bottom: 2rem;
		border: 2px solid #4a90e2;
		position: relative;
	}

	.question-answer {
		background: rgba(126, 34, 206, 0.08);
		padding: 1.5rem;
		padding-right: var(--tts-padding);
		margin-bottom: 1rem;
		border-radius: 0.5rem;
		border-left: 4px solid #7e22ce;
		position: relative;
	}

	.answer {
		color: #7e22ce;
		font-weight: 600;
		font-size: clamp(1rem, 2vw, 1.2rem);
		margin-top: 0.5rem;
	}

	.role-context {
		background: #fff3e0;
		padding: 0.75rem 1rem;
		border-radius: 0.25rem;
		margin-bottom: 0.75rem;
		font-size: clamp(0.95rem, 1.8vw, 1.1rem);
		color: #e65100;
		font-weight: 500;
		word-wrap: break-word;
		overflow-wrap: break-word;
	}

	.starter-line {
		font-style: italic;
		color: #2a5298;
		font-size: clamp(1rem, 2vw, 1.2rem);
		margin-top: 0.5rem;
		word-wrap: break-word;
		overflow-wrap: break-word;
	}

	.instruction {
		color: #2a5298;
		font-size: clamp(1.1rem, 2vw, 1.3rem);
		font-weight: 500;
	}

	.monologue-topic {
		background: linear-gradient(135deg, #4a90e2 0%, #7e22ce 100%);
		color: white;
		padding: 2rem;
		padding-right: var(--tts-padding);
		border-radius: 0.5rem;
		font-size: clamp(1.3rem, 2.5vw, 1.8rem);
		text-align: center;
		margin-bottom: 2rem;
		font-weight: 600;
		position: relative;
	}

	.exam-image-container {
		display: flex;
		justify-content: center;
		align-items: center;
		margin: 2rem 0;
		padding: 1.5rem;
		background: rgba(255, 255, 255, 0.95);
		border-radius: 0.75rem;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
	}

	.exam-image {
		max-width: 100%;
		height: auto;
		border-radius: 0.5rem;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
		display: block;
		margin: 0 auto;
	}

	@media (max-width: 768px) {
		:root {
			--tts-padding: 3rem;
		}

		.section {
			padding: 1.5rem;
		}

		.section h2 {
			flex-direction: column;
			align-items: flex-start;
			gap: 0.5rem;
		}

		.section-timestamp {
			align-self: flex-end;
		}

		.tts-button {
			width: 1.75rem;
			height: 1.75rem;
			font-size: 0.8rem;
		}

		.exam-image-container {
			padding: 1rem;
			margin: 1.5rem 0;
		}

		.exam-image {
			max-width: 100%;
			width: 100%;
		}
	}
</style>

	</head>
	<body>
		<nav
	class="main-nav"
	style="
		background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
		padding: 0.75rem 0;
		margin-bottom: 2rem;
		border-radius: 0;
		position: sticky;
		top: 0;
		z-index: 100;
		box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
		border-bottom: 2px solid rgba(255, 255, 255, 0.1);
	"
>
	<!-- Desktop Navigation -->
	<div class="nav-container desktop-nav">
		    
		<a
			href="/"
			class="nav-link nav-link-active"
		>
			الامتحان
		</a>
		    
		<a
			href="/about.html"
			class="nav-link"
		>
			أسئلة عشوائية
		</a>
		    
		<a
			href="/keywords.html"
			class="nav-link"
		>
			كلمات مهمة
		</a>
		    
		<a
			href="/reminders.html"
			class="nav-link"
		>
			تذكيرات أساسية للامتحان
		</a>
		    
		<a
			href="/drills.html"
			class="nav-link"
		>
			تمارين الجمل
		</a>
		
	</div>

	<!-- Mobile Hamburger Button -->
	<button class="mobile-menu-toggle" aria-label="Toggle menu">
		<span></span>
		<span></span>
		<span></span>
	</button>

	<!-- Mobile Navigation Overlay -->
	<div class="mobile-nav-overlay">
		<div class="mobile-nav-content">
			    
			<a
				href="/"
				class="mobile-nav-link mobile-nav-link-active"
			>
				الامتحان
			</a>
			    
			<a
				href="/about.html"
				class="mobile-nav-link"
			>
				أسئلة عشوائية
			</a>
			    
			<a
				href="/keywords.html"
				class="mobile-nav-link"
			>
				كلمات مهمة
			</a>
			    
			<a
				href="/reminders.html"
				class="mobile-nav-link"
			>
				تذكيرات أساسية للامتحان
			</a>
			    
			<a
				href="/drills.html"
				class="mobile-nav-link"
			>
				تمارين الجمل
			</a>
			
		</div>
	</div>
</nav>
<style>
	/* Desktop Navigation */
	.desktop-nav {
		display: flex;
		justify-content: center;
		align-items: center;
		gap: 2.5rem;
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 1rem;
	}

	.nav-link {
		font-family: "Segoe UI", Tahoma, Arial, sans-serif;
		direction: rtl;
		color: white;
		text-decoration: none;
		font-weight: 600;
		padding: 0.5rem 1.25rem;
		border-radius: 0.5rem;
		transition: all 0.3s ease;
		font-size: 1.1rem;
		position: relative;
		display: inline-block;
	}

	.nav-link:hover {
		background: rgba(255, 255, 255, 0.25) !important;
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
	}

	.nav-link-active {
		background: rgba(255, 255, 255, 0.3) !important;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
	}

	.nav-link-active::after {
		content: "";
		position: absolute;
		bottom: 0.25rem;
		left: 50%;
		transform: translateX(-50%);
		width: 60%;
		height: 2px;
		background: rgba(255, 255, 255, 0.8);
		border-radius: 2px;
	}

	/* Mobile Hamburger Button */
	.mobile-menu-toggle {
		display: none;
		flex-direction: column;
		justify-content: space-around;
		width: 2rem;
		height: 2rem;
		background: transparent;
		border: none;
		cursor: pointer;
		padding: 0;
		z-index: 101;
		position: absolute;
		right: 1rem;
		top: 50%;
		transform: translateY(-50%);
	}

	.mobile-menu-toggle span {
		width: 2rem;
		height: 3px;
		background: white;
		border-radius: 3px;
		transition: all 0.3s ease;
		transform-origin: center;
	}

	.mobile-menu-toggle.active span:nth-child(1) {
		transform: rotate(45deg) translate(8px, 8px);
	}

	.mobile-menu-toggle.active span:nth-child(2) {
		opacity: 0;
	}

	.mobile-menu-toggle.active span:nth-child(3) {
		transform: rotate(-45deg) translate(8px, -8px);
	}

	/* Mobile Navigation Overlay */
	.mobile-nav-overlay {
		display: none;
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100vh;
		background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
		z-index: 100;
		opacity: 0;
		visibility: hidden;
		transition: opacity 0.3s ease, visibility 0.3s ease;
	}

	.mobile-nav-overlay.active {
		opacity: 1;
		visibility: visible;
	}

	.mobile-nav-content {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		height: 100%;
		gap: 2rem;
		padding: 2rem;
	}

	.mobile-nav-link {
		font-family: "Segoe UI", Tahoma, Arial, sans-serif;
		direction: rtl;
		color: white;
		text-decoration: none;
		font-weight: 600;
		font-size: 1.5rem;
		padding: 1rem 2rem;
		border-radius: 0.5rem;
		transition: all 0.3s ease;
		text-align: center;
		width: 100%;
		max-width: 300px;
	}

	.mobile-nav-link:hover {
		background: rgba(255, 255, 255, 0.25);
		transform: scale(1.05);
	}

	.mobile-nav-link-active {
		background: rgba(255, 255, 255, 0.3);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
	}

	/* Mobile Styles */
	@media (max-width: 768px) {
		.main-nav {
			padding: 1.75rem 0 !important;
			position: relative;
		}

		.desktop-nav {
			display: none;
		}

		.mobile-menu-toggle {
			display: flex;
		}

		.mobile-nav-overlay {
			display: block;
		}
	}
</style>

<script>
	// Mobile menu toggle functionality
	document.addEventListener("DOMContentLoaded", function () {
		const menuToggle = document.querySelector(".mobile-menu-toggle");
		const navOverlay = document.querySelector(".mobile-nav-overlay");
		const mobileLinks = document.querySelectorAll(".mobile-nav-link");

		if (menuToggle && navOverlay) {
			menuToggle.addEventListener("click", function () {
				menuToggle.classList.toggle("active");
				navOverlay.classList.toggle("active");
				document.body.style.overflow = navOverlay.classList.contains("active") ? "hidden" : "";
			});

			// Close menu when clicking on a link
			mobileLinks.forEach((link) => {
				link.addEventListener("click", function () {
					menuToggle.classList.remove("active");
					navOverlay.classList.remove("active");
					document.body.style.overflow = "";
				});
			});

			// Close menu when clicking outside
			navOverlay.addEventListener("click", function (e) {
				if (e.target === navOverlay) {
					menuToggle.classList.remove("active");
					navOverlay.classList.remove("active");
					document.body.style.overflow = "";
				}
			});
		}
	});
</script>
 <div class="exam-container">
	<header class="exam-header">
		<h1 class="exam-title"><strong>LanguageCert Preliminary A1 - Speaking &amp; Listening</strong></h1>
		<div class="exam-controls">
			<div class="controls-group">
				<button id="timerBtn" class="timer-btn">09:00</button>
				<button id="nextExamBtn" class="next-exam-btn">الامتحان التالي</button>
				<span id="examCounter" class="exam-counter">1 / 21</span>
			</div>
		</div>
		<div class="exam-meta">
			<p class="exam-level">CEFR A1</p>
			<p class="exam-time">⏱️ Total Time: 8-9 minutes</p>
		</div>
	</header>

	<main id="examContent">
		<div style="text-align: center; padding: 2rem;">
			<p>Loading exam...</p>
		</div>
	</main>
</div>

<script>
	// List of all exam files
	const EXAM_FILES = [
		"new_exams/a1_speaking_practice_paper_1.json",
		"new_exams/a1_speaking_practice_paper_2.json",
		"new_exams/a1_speaking_practice_paper_3.json",
		"new_exams/a1_speaking_practice_paper_4.json",
		"new_exams/a1_speaking_practice_paper_5.json",
		"new_exams/a1_speaking_practice_paper_6.json",
		"new_exams/a1_speaking_practice_paper_7.json",
		"new_exams/a1_speaking_practice_paper_8.json",
		"new_exams/a1_speaking_practice_paper_9.json",
		"new_exams/a1_speaking_practice_paper_10.json",
		"new_exams/a1_speaking_practice_paper_11.json",
		"new_exams/a1_speaking_practice_paper_12.json",
		"new_exams/a1_speaking_practice_paper_13.json",
		"new_exams/a1_speaking_practice_paper_14.json",
		"new_exams/a1_speaking_practice_paper_15.json",
		"new_exams/a1_speaking_practice_paper_16.json",
		"new_exams/a1_speaking_practice_paper_17.json",
		"new_exams/a1_speaking_practice_paper_18.json",
		"new_exams/a1_speaking_practice_paper_19.json",
		"new_exams/a1_speaking_practice_paper_20.json",
		"new_exams/a1_speaking_practice_paper_21.json"
	];

	let shuffledExams = [];
	let currentExamIndex = 0;
	let examData = null;
	let timerInterval = null;
	let timeRemaining = 9 * 60; // 9 minutes in seconds
	let isTimerRunning = false;
	let imageList = [];
	let currentImage = null;

	// Shuffle array function
	function shuffleArray(array) {
		const shuffled = [...array];
		for (let i = shuffled.length - 1; i > 0; i--) {
			const j = Math.floor(Math.random() * (i + 1));
			[shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
		}
		return shuffled;
	}

	// Load image list - matching the pattern from scripts.html
	async function loadImageList() {
		if (imageList.length > 0) {
			return imageList;
		}

		const IMAGES_DIR = "past_papers_images/";

		try {
			// Try to load index.json from images directory
			const indexPath = `${IMAGES_DIR}index.json`;
			const response = await fetch(indexPath);
			if (response.ok) {
				const index = await response.json();
				if (Array.isArray(index)) {
					imageList = index.map((file) =>
						file.endsWith(".png") ? `${IMAGES_DIR}${file}` : `${IMAGES_DIR}${file}.png`
					);
				} else if (index.images && Array.isArray(index.images)) {
					imageList = index.images.map((file) =>
						file.endsWith(".png") ? `${IMAGES_DIR}${file}` : `${IMAGES_DIR}${file}.png`
					);
				}
				console.log(`Loaded ${imageList.length} images from index`);
				return imageList;
			}
		} catch (error) {
			console.log("No images index.json found, using fallback list");
		}

		// Fallback: use hardcoded list
		imageList = [
			`${IMAGES_DIR}ChatGPT Image Nov 30, 2025, 01_00_27 PM.png`,
			`${IMAGES_DIR}ChatGPT Image Nov 30, 2025, 01_07_47 PM.png`,
			`${IMAGES_DIR}ChatGPT Image Nov 30, 2025, 01_09_46 PM.png`,
			`${IMAGES_DIR}ChatGPT Image Nov 30, 2025, 12_29_40 PM.png`,
			`${IMAGES_DIR}ChatGPT Image Nov 30, 2025, 12_32_22 PM.png`,
			`${IMAGES_DIR}ChatGPT Image Nov 30, 2025, 12_34_05 PM.png`,
			`${IMAGES_DIR}ChatGPT Image Nov 30, 2025, 12_55_07 PM.png`,
			`${IMAGES_DIR}ChatGPT Image Nov 30, 2025, 12_56_45 PM.png`
		];
		return imageList;
	}

	// Get random image - returns full path (synchronous, not async)
	function getRandomExamImage() {
		console.log("getRandomExamImage called - imageList:", imageList, "length:", imageList ? imageList.length : 0);
		if (!imageList || imageList.length === 0) {
			console.log("Image list is empty or undefined");
			return null;
		}
		const randomIndex = Math.floor(Math.random() * imageList.length);
		const selectedImage = imageList[randomIndex];
		console.log("Selected image at index", randomIndex, ":", selectedImage);
		// Ensure it's a string, not a Promise or other object
		if (typeof selectedImage !== 'string') {
			console.error("Selected image is not a string:", selectedImage, "Type:", typeof selectedImage);
			return null;
		}
		console.log("Selected image path:", selectedImage);
		return selectedImage;
	}

	// Initialize shuffled exams on first load
	function initializeExams() {
		if (shuffledExams.length === 0) {
			shuffledExams = shuffleArray(EXAM_FILES);
		}
	}

	// Load exam data
	async function loadExamData(examPath) {
		try {
			const response = await fetch(examPath);
			if (!response.ok) {
				throw new Error(`Failed to load ${examPath}`);
			}
			examData = await response.json();
			console.log("Loaded exam data:", examData);
			return examData;
		} catch (error) {
			console.error("Error loading exam data:", error);
			document.getElementById("examContent").innerHTML =
				'<div class="exam-section"><p style="color: #d32f2f; text-align: center;">Error loading exam data. Please ensure the file exists.</p></div>';
			return null;
		}
	}

	// Timer functions - using unique names to avoid conflicts with scripts.html
	function toggleExamTimer() {
		if (isTimerRunning) {
			pauseExamTimer();
		} else {
			startExamTimer();
		}
	}

	function startExamTimer() {
		if (timeRemaining <= 0) {
			timeRemaining = 9 * 60; // Reset to 9 minutes if expired
		}
		
		isTimerRunning = true;
		updateExamTimerDisplay();
		
		if (timerInterval) {
			clearInterval(timerInterval);
		}
		
		timerInterval = setInterval(() => {
			timeRemaining--;
			updateExamTimerDisplay();
			
			if (timeRemaining <= 0) {
				clearInterval(timerInterval);
				timerInterval = null;
				isTimerRunning = false;
				const timerBtn = document.getElementById("timerBtn");
				if (timerBtn) {
					timerBtn.textContent = "00:00";
					timerBtn.classList.add("timer-expired");
					timerBtn.classList.remove("timer-running");
				}
			}
		}, 1000);
	}

	function pauseExamTimer() {
		isTimerRunning = false;
		if (timerInterval) {
			clearInterval(timerInterval);
			timerInterval = null;
		}
		updateExamTimerDisplay(); // Update display to remove running state
	}

	function resetExamTimer() {
		pauseExamTimer();
		timeRemaining = 9 * 60;
		updateExamTimerDisplay();
	}

	function updateExamTimerDisplay() {
		const minutes = Math.floor(timeRemaining / 60);
		const seconds = timeRemaining % 60;
		const timerElement = document.getElementById("timerBtn");
		if (timerElement) {
			const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
			timerElement.textContent = timeString;
			timerElement.classList.remove("timer-expired");
			
			// Update button state visual indicator
			if (isTimerRunning) {
				timerElement.classList.add("timer-running");
			} else {
				timerElement.classList.remove("timer-running");
			}
		}
	}

	function updateExamCounter() {
		document.getElementById("examCounter").textContent = `${currentExamIndex + 1} / ${shuffledExams.length}`;
	}

	// Load next exam
	async function loadNextExam() {
		currentExamIndex = (currentExamIndex + 1) % shuffledExams.length;
		await loadAndDisplayExam();
		resetExamTimer();
	}

	// Display exam content
	function displayExam() {
		if (!examData) return;

		const content = document.getElementById("examContent");
		let html = "";

		// Exam instructions in Arabic
		html += `
			<div class="exam-instructions">
				<p><strong>ملاحظات مهمة:</strong></p>
				<p>عندما ترى "Interlocutor" أو "الممتحن" قبل السؤال أو النص، فهذا يعني أن الممتحن هو من سيقول هذا الكلام أو يطرح هذا السؤال.</p>
				<p>عندما ترى "Candidate" أو "الممتحَن" قبل النص، فهذا يعني أنك أنت من يجب أن تقول هذا الكلام أو تطرح هذا السؤال.</p>
				<p>تحتوي هذه الورقة على تعليمات للممتحن أيضاً. تعليمات الممتحن وما قد يقوله محدد باللون البرتقالي.</p>
			</div>
		`;

		// Part 1 - Interview (hardcoded structure)
		const part1 = examData.parts.part1;
		html += `
			<div class="exam-section">
				<div class="part-header">
					<h2>Part 1 – Interview</h2>
					<span class="duration">1 minute 30 seconds</span>
				</div>
				<div class="section-description">
					<p>في هذا الجزء، سيقوم الممتحن بطرح أسئلة شخصية بسيطة عليك. ستبدأ بأسئلة تعريفية ثابتة مثل تهجئة اسمك والعيش، ثم أسئلة شخصية عن روتينك اليومي واهتماماتك. استجب بشكل طبيعي وواضح.</p>
				</div>
				<div class="interlocutor-section">
					<h3 class="speaker-label">Interlocutor (I):</h3>
					<p class="dialogue orange-dialogue">LanguageCert ESOL International, Speaking and Listening, Preliminary level</p>
					
					<h4 class="subsection-title">Fixed Introduction Questions:</h4>
					<ul class="question-list">
						${part1.fixed_intro_questions.map(q => `
							<li class="question-item">
								<p class="dialogue"><strong>Interlocutor:</strong> ${q.text}</p>
							</li>
						`).join("")}
					</ul>
					
					<h4 class="subsection-title">Personal Questions:</h4>
					<ul class="question-list">
						${part1.personal_questions.map(q => `
							<li class="question-item">
								<p class="dialogue"><strong>Interlocutor:</strong> ${q.text}</p>
							</li>
						`).join("")}
					</ul>
					
					<p class="dialogue orange-dialogue"><strong>Interlocutor:</strong> Thank you.</p>
				</div>
			</div>
		`;

		// Part 2 - Role-play (hardcoded structure with contextual instructions)
		const part2 = examData.parts.part2;
		html += `
			<div class="exam-section">
				<div class="part-header">
					<h2>Part 2 – Role-play</h2>
					<span class="duration">1 minute 30 seconds</span>
				</div>
				<div class="section-description">
					<p>سيضعك الممتحن في مواقف يومية مختلفة. في الموقف الأول (A)، سيبدأ الممتحن بطرح سؤال عليك وعليك أن تجيب عليه. في الموقف الثاني (B)، ستحصل على سيناريو وعليك أن تبتكر سؤالاً مناسباً بناءً على الموقف. استخدم اللغة المناسبة للموقف (صديق، زميل، جار، زميل دراسة) وتفاعل بشكل طبيعي.</p>
				</div>
				<div class="interlocutor-section">
					<h3 class="speaker-label">Interlocutor (I):</h3>
					<p class="dialogue orange-dialogue"><strong>Interlocutor:</strong> Now, Part Two. I'm going to read some situations. I want you to start or answer. First situation (choose one situation from A).</p>
					
					<h4 class="subsection-title">Situation A (Interlocutor starts):</h4>
					<p class="instruction-note">(Role-play the situation with the candidate – approximately two turns each.)</p>
					<ul class="situation-list">
						${part2.situations_A.map(sit => `
							<li class="situation-item">
								<p class="context"><strong>Context:</strong> ${sit.context}</p>
								<p class="dialogue"><strong>Interlocutor:</strong> ${sit.interlocutor_opening}</p>
							</li>
						`).join("")}
					</ul>
					
					<h4 class="subsection-title">Situation B (Candidate starts):</h4>
					<p class="dialogue orange-dialogue"><strong>Interlocutor:</strong> Second situation (choose one situation from B).</p>
					<p class="instruction-note">(Role-play the situation with the candidate – approximately two turns each.)</p>
					<ul class="situation-list">
						${part2.situations_B.map(sit => `
							<li class="situation-item">
								<p class="context"><strong>Context:</strong> ${sit.context}</p>
								<p class="candidate-prompt"><strong>Interlocutor:</strong> ${sit.candidate_prompt}</p>
							</li>
						`).join("")}
					</ul>
					
					<p class="dialogue orange-dialogue"><strong>Interlocutor:</strong> Thank you.</p>
				</div>
			</div>
		`;

		// Part 3 - Comparing pictures (hardcoded structure)
		const part3 = examData.parts.part3;
		html += `
			<div class="exam-section">
				<div class="part-header">
					<h2>Part 3 – Comparing pictures (hotel)</h2>
					<span class="duration">1 minute – 1 minute 30 seconds</span>
				</div>
				<div class="section-description">
					<p>ستحصل على صورتين. عن الصورة الأولى، سيسألك الممتحن أسئلة وعليك الإجابة عليها. عن الصورة الثانية، أنت من ستبتكر الأسئلة وطرحها على الممتحن. استخدم كلمات بسيطة لوصف ما تراه واطرح أسئلة واضحة.</p>
				</div>
				<div class="interlocutor-section">
					<h3 class="speaker-label">Interlocutor (I):</h3>
					<p class="dialogue orange-dialogue"><strong>Interlocutor:</strong> Here are two pictures. Let's ask and answer questions about the two pictures. I'll ask you questions from the left picture which you will answer, and you will ask me questions from the right picture which I will answer.</p>
					<div class="exam-image-container">
						<img id="part3-image" src="" alt="Exam pictures" class="exam-image" />
					</div>
					<p class="dialogue orange-dialogue"><strong>Interlocutor:</strong> Thank you.</p>
				</div>
			</div>
		`;

		// Part 4 - Listening and long turn (hardcoded structure)
		const part4 = examData.parts.part4;
		
		// Part 4A - Listening task
		const part4A = part4.subparts.part4A;
		html += `
			<div class="exam-section">
				<div class="part-header">
					<h2>Part 4A – Listening task</h2>
					<span class="duration">2 minutes – 2 minutes 30 seconds</span>
				</div>
				<div class="section-description">
					<p>سيقرأ الممتحن قصة قصيرة مرتين. استمع جيداً واكتب ملاحظات على ورقتك. بعد ذلك، سيسألك الممتحن أسئلة عن القصة. ركز على المعلومات المهمة مثل الوظيفة، الوقت، والأماكن.</p>
				</div>
				<div class="interlocutor-section">
					<h3 class="speaker-label">Interlocutor (I):</h3>
					<p class="dialogue orange-dialogue"><strong>Interlocutor:</strong> In Part Four I'm going to read something. I'm going to tell you about ______'s best friend. I'll read it two times. Listen and take notes on your paper. I'll then ask you these questions.</p>
					<p class="instruction-note">(Allow 10 seconds for the candidate to read the questions.)</p>
					
					<h4 class="subsection-title">Listening Script:</h4>
					<p class="instruction-note">(Read script at an appropriate pace.)</p>
					<ul class="question-list">
						<li class="question-item purple-item">
							<p class="dialogue"><strong>Interlocutor:</strong> <span class="script-text">${part4A.listening_script}</span></p>
						</li>
					</ul>
					
					<p class="dialogue orange-dialogue"><strong>Interlocutor:</strong> Now I'll read it again. (Read the script again.)</p>
					
					<h4 class="subsection-title">Questions:</h4>
					<p class="dialogue orange-dialogue"><strong>Interlocutor:</strong> Questions. (Ask the following questions, allowing time for the candidate to respond orally.)</p>
					<ul class="question-list">
						${part4A.questions.map(q => `
							<li class="question-item">
								<p class="dialogue"><strong>Interlocutor:</strong> ${q.text}</p>
							</li>
						`).join("")}
					</ul>
					
					<p class="dialogue orange-dialogue"><strong>Interlocutor:</strong> Thank you.</p>
				</div>
			</div>
		`;

		// Part 4B - Long turn and follow-up
		const part4B = part4.subparts.part4B;
		html += `
			<div class="exam-section">
				<div class="part-header">
					<h2>Part 4B – Long turn and follow-up</h2>
					<span class="duration">2 minutes including follow-up questions</span>
				</div>
				<div class="section-description">
					<p>ستتحدث وحدك لمدة نصف دقيقة عن موضوع محدد. ستحصل على 30 ثانية لكتابة ملاحظات قبل البدء. تحدث بوضوح عن الموضوع باستخدام كلمات بسيطة. بعد ذلك، سيسألك الممتحن أسئلة متابعة عن الموضوع.</p>
				</div>
				<div class="interlocutor-section">
					<h3 class="speaker-label">Interlocutor (I):</h3>
					<p class="dialogue orange-dialogue"><strong>Interlocutor:</strong> Now you're going to talk on your own for half a minute. Your topic is ______. You now have thirty seconds to write some notes to help you. You're going to talk about your topic.</p>
					
					<h4 class="subsection-title">Topic:</h4>
					<ul class="question-list">
						<li class="question-item purple-item">
							<p class="dialogue"><strong>Interlocutor:</strong> <span class="topic-title">${part4B.topic.title}</span></p>
						</li>
					</ul>
					
					<p class="dialogue orange-dialogue">(Candidate's name), please start.</p>
					<p class="instruction-note">(When candidate has talked for a maximum of half a minute, say, 'Thank you', and then ask follow-up questions, as time allows.)</p>
					
					<h4 class="subsection-title">Follow-up Questions:</h4>
					<ul class="question-list">
						${part4B.follow_up_questions.map(q => `
							<li class="question-item">
								<p class="dialogue"><strong>Interlocutor:</strong> ${q.text}</p>
							</li>
						`).join("")}
					</ul>
					
					<p class="dialogue orange-dialogue"><strong>Interlocutor:</strong> Thank you, (give candidate's name). That is the end of the exam.</p>
				</div>
			</div>
		`;

		content.innerHTML = html;

		// Load and set image after content is rendered (matching scripts.html pattern)
		// Use setTimeout to ensure DOM is ready
		setTimeout(() => {
			const imgElement = document.getElementById("part3-image");
			if (!imgElement) {
				console.error("Image element not found");
				return;
			}
			
			if (currentImage && typeof currentImage === 'string' && currentImage.trim() !== '') {
				console.log("Setting image src to:", currentImage);
				// Ensure the path is a valid string
				const imagePath = String(currentImage).trim();
				imgElement.src = imagePath;
				imgElement.onerror = function () {
					console.error("Failed to load image:", imagePath);
					const container = this.closest(".exam-image-container");
					if (container) {
						container.style.display = "none";
					}
				};
			} else {
				console.log("No image available (currentImage:", currentImage, "), hiding container");
				const container = imgElement.closest(".exam-image-container");
				if (container) {
					container.style.display = "none";
				}
			}
		}, 0);
	}

	// Load and display exam
	async function loadAndDisplayExam() {
		initializeExams();
		
		// Load images first and wait for completion
		await loadImageList();
		console.log("Image list after loading:", imageList, "Length:", imageList.length);
		
		// Get random image - ensure it's a string (synchronous function)
		const randomImage = getRandomExamImage();
		console.log("Random image from getRandomExamImage():", randomImage, "Type:", typeof randomImage);
		
		if (randomImage && typeof randomImage === 'string') {
			currentImage = randomImage; // Store as string
			console.log("Current image path set to:", currentImage, "Type:", typeof currentImage);
		} else {
			currentImage = null;
			console.log("No valid image selected - imageList length:", imageList.length);
		}
		
		const examPath = shuffledExams[currentExamIndex];
		await loadExamData(examPath);
		if (examData) {
			displayExam();
			updateExamCounter();
		}
	}

	// Load and display exam on page load
	(async function() {
		initializeExams();
		// Start with the first exam in the shuffled array
		currentExamIndex = 0;
		await loadAndDisplayExam();
		resetExamTimer();
		
		// Set up button event listeners - wait for DOM to be ready
		setTimeout(() => {
			const nextBtn = document.getElementById("nextExamBtn");
			const timerBtn = document.getElementById("timerBtn");
			
			if (nextBtn) {
				nextBtn.addEventListener("click", loadNextExam);
			} else {
				console.error("Next exam button not found");
			}
			
			if (timerBtn) {
				timerBtn.addEventListener("click", toggleExamTimer);
				console.log("Timer button event listener attached");
			} else {
				console.error("Timer button not found");
			}
		}, 100);
	})();
</script>

<style>
	.exam-container {
		background: #ffffff;
		color: #000000;
		min-height: 100vh;
		padding: 0;
		margin: 0;
	}

	.exam-header {
		background: #ffffff;
		color: #000000;
		padding: 2rem 2rem 1.5rem 2rem;
		text-align: center;
		border-bottom: 2px solid #000000;
	}

	.exam-title {
		font-size: 2rem;
		font-weight: 900;
		margin: 0 0 0.75rem 0;
		color: #000000 !important;
		letter-spacing: -0.5px;
		line-height: 1.2;
		background: none !important;
		-webkit-background-clip: unset !important;
		-webkit-text-fill-color: #000000 !important;
		background-clip: unset !important;
	}

	.exam-title strong {
		font-weight: 900;
		color: #000000 !important;
		-webkit-text-fill-color: #000000 !important;
	}

	.exam-controls {
		display: flex;
		justify-content: center;
		align-items: center;
		margin-bottom: 1rem;
		flex-wrap: wrap;
		gap: 1rem;
	}

	.controls-group {
		display: flex;
		align-items: center;
		gap: 1rem;
		flex-wrap: wrap;
		justify-content: center;
	}

	.timer-btn {
		font-size: 1.2rem;
		font-weight: 700;
		color: #000000;
		background-color: #f0f0f0;
		padding: 0.5rem 1rem;
		border-radius: 4px;
		font-family: monospace;
		border: 2px solid #000000;
		cursor: pointer;
		transition: all 0.3s ease;
		min-width: 80px;
		user-select: none;
		-webkit-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
	}

	.timer-btn:hover {
		background-color: #e0e0e0;
	}

	.timer-btn:active {
		transform: scale(0.98);
	}

	.timer-expired {
		color: #ffffff;
		background-color: #ff6b6b;
		border-color: #ff6b6b;
	}

	.next-exam-btn {
		background-color: #000000;
		color: #ffffff;
		border: 2px solid #000000;
		padding: 0.5rem 1.5rem;
		border-radius: 4px;
		font-size: 0.95rem;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.3s ease;
	}

	.next-exam-btn:hover {
		background-color: #333333;
		border-color: #333333;
	}

	.exam-counter {
		font-size: 0.95rem;
		color: #000000;
		font-weight: 600;
		background-color: #f0f0f0;
		padding: 0.5rem 1rem;
		border-radius: 4px;
		border: 2px solid #000000;
	}

	.exam-meta {
		display: flex;
		justify-content: center;
		gap: 2rem;
		flex-wrap: wrap;
		margin-top: 0.5rem;
	}

	.exam-level,
	.exam-time {
		margin: 0;
		font-size: 0.95rem;
		color: #000000;
		font-weight: 500;
	}

	#examContent {
		max-width: 800px;
		margin: 0 auto;
		padding: 3rem 2rem;
		background: #ffffff;
		line-height: 1.6;
	}

	.exam-instructions {
		background-color: #fff7ed;
		border: 2px solid #ffedd5;
		padding: 1.5rem;
		margin-bottom: 2rem;
		border-radius: 4px;
	}

	.exam-instructions p {
		margin: 0.75rem 0;
		color: #333333;
		line-height: 1.7;
		text-align: right;
		direction: rtl;
	}

	.exam-instructions p:first-child {
		margin-top: 0;
	}

	.exam-instructions p:last-child {
		margin-bottom: 0;
	}

	.exam-instructions strong {
		color: #000000;
		font-weight: 700;
	}

	.exam-section {
		background: #ffffff;
		margin-bottom: 3rem;
		padding: 0;
		page-break-inside: avoid;
	}

	.part-header {
		display: flex;
		justify-content: space-between;
		align-items: baseline;
		margin-bottom: 1.5rem;
		padding-bottom: 0.5rem;
		border-bottom: 1px solid #000000;
	}

	.part-header h2 {
		font-size: 1.4rem;
		font-weight: 700;
		margin: 0;
		color: #000000;
	}

	.duration {
		color: #000000;
		font-weight: 600;
		font-size: 0.95rem;
	}

	.section-description {
		background-color: #f8f9fa;
		padding: 1rem 1.5rem;
		margin: 1rem 0;
		border-left: 3px solid #666666;
		border-radius: 4px;
	}

	.section-description p {
		margin: 0;
		color: #333333;
		line-height: 1.6;
		font-size: 0.95rem;
		text-align: right;
		direction: rtl;
	}

	.interlocutor-section {
		color: #000000;
		margin-top: 1rem;
	}

	.speaker-label {
		font-size: 1.1rem;
		font-weight: 700;
		margin: 0 0 1rem 0;
		color: #000000;
	}

	.subsection-title {
		font-size: 1rem;
		font-weight: 600;
		margin: 2rem 0 0.75rem 0;
		color: #000000;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}

	.dialogue {
		margin: 0.5rem 0;
		padding: 0;
		line-height: 1.7;
		color: #000000;
	}

	.dialogue p {
		margin: 0.5rem 0;
		line-height: 1.7;
		color: #000000;
	}

	.situation-list {
		list-style: none;
		padding: 0;
		margin: 1rem 0;
	}

	.situation-item {
		margin: 1.25rem 0;
		padding-left: 1.5rem;
		position: relative;
	}

	.situation-item::before {
		content: "•";
		position: absolute;
		left: 0;
		font-size: 1.2rem;
		color: #000000;
		font-weight: bold;
	}

	.context {
		font-weight: 600;
		margin: 0 0 0.5rem 0;
		color: #000000;
	}

	.candidate-prompt {
		margin: 0.5rem 0;
		padding: 0;
		color: #000000;
		line-height: 1.7;
	}

	.candidate-label {
		color: #0066cc;
		font-weight: 700;
	}

	.notes {
		margin: 0.5rem 0 0 0;
		color: #666666;
		font-size: 0.9rem;
		font-style: italic;
	}

	.instruction-note {
		margin: 0.5rem 0;
		padding: 0;
		color: #666666;
		font-size: 0.9rem;
		font-style: italic;
	}

	.script-text {
		line-height: 1.8;
		color: #000000;
	}

	.topic-title {
		font-size: 1.1rem;
		margin: 0.5rem 0;
		color: #000000;
		font-weight: 600;
	}

	.topic-prompt {
		margin: 0.5rem 0 0 0;
		color: #000000;
		line-height: 1.7;
	}

	.question-list {
		list-style: none;
		padding: 0;
		margin: 0.75rem 0;
	}

	.question-item {
		margin: 0.75rem 0;
		padding-left: 1.5rem;
		position: relative;
	}

	.question-item::before {
		content: "•";
		position: absolute;
		left: 0;
		font-size: 1.2rem;
		color: #000000;
		font-weight: bold;
	}

	.purple-item {
		background-color: #e9d5ff;
		padding: 0.75rem 1rem;
		margin: 0.75rem 0;
		border-radius: 4px;
	}

	.purple-item::before {
		color: #7b2cbf;
	}

	.purple-item .dialogue,
	.purple-item .dialogue strong,
	.purple-item .script-text,
	.purple-item .topic-title,
	.purple-item .topic-prompt {
		color: #000000;
	}

	.orange-dialogue {
		background-color: #ffedd5;
		padding: 0.75rem 1rem;
		margin: 0.5rem 0;
		border-radius: 4px;
		color: #000000;
	}

	.orange-dialogue strong {
		color: #000000;
	}

	.exam-image-container {
		margin: 1.5rem 0;
		text-align: center;
	}

	.exam-image {
		max-width: 100%;
		width: 100%;
		height: auto;
		border: 2px solid #000000;
		border-radius: 4px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		display: block;
		margin: 0 auto;
	}

	.timer-running {
		background-color: #d4edda !important;
		border-color: #28a745 !important;
	}

	@media (max-width: 768px) {
		.exam-header {
			padding: 1rem 0.75rem;
		}

		.exam-title {
			font-size: 1.5rem;
			font-weight: 900;
			margin-bottom: 0.5rem;
			line-height: 1.3;
		}

		.exam-controls {
			flex-direction: column;
			align-items: stretch;
			gap: 0.75rem;
			margin-bottom: 0.75rem;
		}

		.controls-group {
			width: 100%;
			justify-content: center;
			flex-wrap: wrap;
			gap: 0.75rem;
		}

		.timer-btn {
			flex: 1;
			min-width: 100px;
			font-size: 1rem;
			padding: 0.5rem 0.75rem;
		}

		.next-exam-btn {
			flex: 1;
			min-width: 140px;
			font-size: 0.9rem;
			padding: 0.5rem 1rem;
		}

		.exam-counter {
			font-size: 0.85rem;
			padding: 0.4rem 0.75rem;
		}

		.exam-meta {
			flex-direction: column;
			gap: 0.5rem;
			margin-top: 0.5rem;
		}

		.exam-level,
		.exam-time {
			font-size: 0.85rem;
		}

		#examContent {
			padding: 1.5rem 1rem;
		}

		.exam-instructions {
			padding: 1rem;
			margin-bottom: 1.5rem;
		}

		.exam-instructions p {
			font-size: 0.9rem;
		}

		.exam-section {
			margin-bottom: 2rem;
		}

		.part-header {
			flex-direction: column;
			align-items: flex-start;
			gap: 0.5rem;
		}

		.part-header h2 {
			font-size: 1.2rem;
		}

		.duration {
			font-size: 0.85rem;
		}

		.situation-item,
		.question-item {
			padding-left: 1.25rem;
		}

		.exam-image-container {
			margin: 1rem 0;
			padding: 0;
		}

		.exam-image {
			max-width: 100%;
			width: 100%;
			border-width: 1px;
		}

		.section-description {
			padding: 0.75rem 1rem;
			margin: 0.75rem 0;
		}

		.section-description p {
			font-size: 0.85rem;
		}

		.dialogue {
			font-size: 0.95rem;
		}

		.orange-dialogue {
			padding: 0.5rem 0.75rem;
		}

		.purple-item {
			padding: 0.5rem 0.75rem;
		}
	}
</style>

 <script>
	// Cache for available papers
	let availablePapers = [];
	const PAST_PAPERS_DIR = "past_papers/";

	// Function to load the papers index
	async function loadPapersIndex() {
		if (availablePapers.length > 0) {
			return availablePapers; // Already loaded
		}

		try {
			// Try to load index.json from root directory first (where it actually exists)
			const rootResponse = await fetch("index.json");
			if (rootResponse.ok) {
				const index = await rootResponse.json();
				if (Array.isArray(index)) {
					availablePapers = index.map((file) =>
						file.startsWith(PAST_PAPERS_DIR) ? file : `${PAST_PAPERS_DIR}${file}`
					);
				} else if (index.papers && Array.isArray(index.papers)) {
					availablePapers = index.papers.map((file) =>
						file.startsWith(PAST_PAPERS_DIR) ? file : `${PAST_PAPERS_DIR}${file}`
					);
				}
			} else {
				// Fallback: try past_papers directory (in case it exists there)
				const indexPath = `${PAST_PAPERS_DIR}index.json`;
				const response = await fetch(indexPath);
				if (response.ok) {
					const index = await response.json();
					if (Array.isArray(index)) {
						availablePapers = index.map((file) =>
							file.startsWith(PAST_PAPERS_DIR) ? file : `${PAST_PAPERS_DIR}${file}`
						);
					} else if (index.papers && Array.isArray(index.papers)) {
						availablePapers = index.papers.map((file) =>
							file.startsWith(PAST_PAPERS_DIR) ? file : `${PAST_PAPERS_DIR}${file}`
						);
					}
				} else {
					throw new Error("No index.json found");
				}
			}

			console.log(`Loaded ${availablePapers.length} papers from index`);
			return availablePapers;
		} catch (error) {
			console.error("Error loading papers index:", error);
			// Fallback: try pattern-based discovery
			return await discoverPapersByPattern();
		}
	}

	// Fallback: discover papers by trying common patterns
	async function discoverPapersByPattern() {
		const discovered = [];
		const promises = [];

		// Try papers from 001 to 100
		for (let i = 1; i <= 100; i++) {
			const num = i.toString().padStart(3, "0");
			const filename = `${PAST_PAPERS_DIR}a1_paper_${num}.json`;

			promises.push(
				fetch(filename, { method: "HEAD" })
					.then((response) => {
						if (response.ok) {
							discovered.push(filename);
						}
					})
					.catch(() => {})
			);
		}

		await Promise.allSettled(promises);
		availablePapers = discovered.sort();
		console.log(`Discovered ${availablePapers.length} papers by pattern`);
		return availablePapers;
	}

	// Function to get a random paper filename
	function getRandomPaper() {
		if (availablePapers.length === 0) {
			return `${PAST_PAPERS_DIR}a1_paper_001.json`; // fallback
		}
		const randomIndex = Math.floor(Math.random() * availablePapers.length);
		return availablePapers[randomIndex];
	}

	// Cache for available images
	let availableImages = [];

	// Function to load images index
	async function loadImagesIndex() {
		if (availableImages.length > 0) {
			return availableImages; // Already loaded
		}

		const IMAGES_DIR = "past_papers_images/";

		try {
			// Try to load index.json from images directory
			const indexPath = `${IMAGES_DIR}index.json`;
			const response = await fetch(indexPath);
			if (response.ok) {
				const index = await response.json();
				if (Array.isArray(index)) {
					availableImages = index.map((file) =>
						file.endsWith(".png") ? `${IMAGES_DIR}${file}` : `${IMAGES_DIR}${file}.png`
					);
				} else if (index.images && Array.isArray(index.images)) {
					availableImages = index.images.map((file) =>
						file.endsWith(".png") ? `${IMAGES_DIR}${file}` : `${IMAGES_DIR}${file}.png`
					);
				}
				console.log(`Loaded ${availableImages.length} images from index`);
				return availableImages;
			}
		} catch (error) {
			console.log("No images index.json found, will discover images");
		}

		// Fallback: discover images by trying common patterns
		return await discoverImagesByPattern();
	}

	// Fallback: discover images by trying common patterns
	async function discoverImagesByPattern() {
		const IMAGES_DIR = "past_papers_images/";
		const discovered = [];
		const promises = [];

		// Try common naming patterns
		const patterns = [
			// Try numbered patterns: image_01.png, image_1.png, img_01.png, etc.
			...Array.from({ length: 20 }, (_, i) => {
				const num = (i + 1).toString().padStart(2, "0");
				return [
					`${IMAGES_DIR}image_${num}.png`,
					`${IMAGES_DIR}img_${num}.png`,
					`${IMAGES_DIR}${num}.png`,
				];
			}).flat(),
			// Try single digits
			...Array.from({ length: 10 }, (_, i) => `${IMAGES_DIR}image_${i + 1}.png`),
		];

		// Remove duplicates
		const uniquePatterns = [...new Set(patterns)];

		for (const filename of uniquePatterns) {
			promises.push(
				fetch(filename, { method: "HEAD" })
					.then((response) => {
						if (response.ok) {
							discovered.push(filename);
						}
					})
					.catch(() => {})
			);
		}

		await Promise.allSettled(promises);
		availableImages = discovered.sort();
		console.log(`Discovered ${availableImages.length} images by pattern`);
		return availableImages;
	}

	// Function to get a random image from past_papers_images directory
	async function getRandomImage() {
		// Ensure images are loaded
		if (availableImages.length === 0) {
			await loadImagesIndex();
		}

		if (availableImages.length === 0) {
			// No images found, return null to hide the image section
			return null;
		}

		const randomIndex = Math.floor(Math.random() * availableImages.length);
		return availableImages[randomIndex];
	}

	// Timer functionality (defined early so it can be used by loadPaper)
	const timers = {
		personal: { interval: null, remaining: 90, total: 90, running: false },
		situations: { interval: null, remaining: 90, total: 90, running: false },
		image: { interval: null, remaining: 90, total: 90, running: false },
		listening: { interval: null, remaining: 120, total: 120, running: false },
		monologue: { interval: null, remaining: 120, total: 120, running: false },
	};

	function formatTime(seconds) {
		const mins = Math.floor(seconds / 60);
		const secs = seconds % 60;
		return `${mins}:${secs.toString().padStart(2, "0")}`;
	}

	function updateTimerDisplay(section) {
		const timer = timers[section];
		const display = document.getElementById(`timer-${section}`);
		const button = document.getElementById(`timer-btn-${section}`);
		if (display) {
			display.textContent = formatTime(timer.remaining);
			if (timer.running) {
				display.classList.add("timer-running");
			} else {
				display.classList.remove("timer-running");
			}
		}
		if (button) {
			button.textContent = timer.running ? "⏸" : "▶";
		}
	}

	function resetAllTimers() {
		Object.keys(timers).forEach((section) => {
			const timer = timers[section];
			if (timer.interval) {
				clearInterval(timer.interval);
			}
			timer.remaining = timer.total;
			timer.running = false;
			updateTimerDisplay(section);
		});
	}

	// Function to load a specific paper
	function loadPaper(filename) {
		// Reset all timers when loading new paper
		resetAllTimers();

		document.getElementById("content").innerHTML =
			'<p style="text-align: center; color: white; font-size: 1.2rem;">Loading content...</p>';

		fetch(filename)
			.then((response) => {
				if (!response.ok) {
					throw new Error(`Failed to load ${filename}`);
				}
				return response.json();
			})
			.then((data) => {
				displayContent(data);
				document.getElementById("currentPaper").textContent = `Current: ${data.id || filename}`;
			})
			.catch((error) => {
				document.getElementById(
					"content"
				).innerHTML = `<p style="color: #ff6b6b; text-align: center;">Error loading ${filename}. Please ensure the file exists.</p>`;
				console.error("Error:", error);
				document.getElementById("currentPaper").textContent = "";
			});
	}

	// Function to load a random paper
	async function loadRandomPaper() {
		// Ensure papers are loaded
		if (availablePapers.length === 0) {
			document.getElementById("content").innerHTML =
				'<p style="text-align: center; color: white; font-size: 1.2rem;">Loading available papers...</p>';
			await loadPapersIndex();
		}

		const currentPaper = document.getElementById("currentPaper").textContent;
		let randomPaper;

		// If there's only one paper, just reload it
		if (availablePapers.length <= 1) {
			randomPaper = availablePapers[0] || `${PAST_PAPERS_DIR}a1_paper_001.json`;
		} else {
			// Get a different random paper (avoid loading the same one if possible)
			do {
				randomPaper = getRandomPaper();
			} while (
				availablePapers.length > 1 &&
				currentPaper.includes(randomPaper.replace(".json", "").replace(PAST_PAPERS_DIR, ""))
			);
		}

		// Scroll to top and load the paper
		window.scrollTo({ top: 0, behavior: "smooth" });
		loadPaper(randomPaper);
	}

	// Make function globally accessible
	window.loadRandomPaper = loadRandomPaper;

	// Load initial paper on page load
	(async function () {
		await loadPapersIndex();
		if (availablePapers.length > 0) {
			loadPaper(availablePapers[0]);
		} else {
			// Fallback if no papers found
			loadPaper(`${PAST_PAPERS_DIR}a1_paper_001.json`);
		}
	})();

	// Also attach event listener as backup (in addition to onclick)
	document.addEventListener("DOMContentLoaded", function () {
		const button = document.getElementById("randomButton");
		if (button) {
			button.addEventListener("click", function (e) {
				e.preventDefault();
				loadRandomPaper();
			});
		}
	});

	function displayContent(data) {
		const content = document.getElementById("content");
		let html = "";

		// Personal Information Section
		html += `
                <section class="section">
                    <h2>
                        <span class="arabic-text">المعلومات الشخصية</span>
                        <span class="section-timestamp">
                            <button class="timer-button" onclick="toggleTimer('personal', 90)" id="timer-btn-personal">▶</button>
                            <span class="timer-display" id="timer-personal">1:30</span>
                        </span>
                    </h2>
                    <p class="section-subtitle arabic-text">أسئلة تمهيدية وعامة للتعرف على المرشح</p>
                    
                    <h3 class="subsection-title arabic-text">أسئلة تمهيدية</h3>
                    <p class="subsection-subtitle arabic-text">أسئلة عامة عنك.</p>
                    ${data.personal_information.intro_questions
											.map(
												(q) => `
                        <div class="question-item">
                            <button class="tts-button" onclick="speakText('${q.text.replace(
															/'/g,
															"\\'"
														)}', this)" title="Read aloud">🔊</button>
                            <p class="question-text">${q.text}</p>
                        </div>
                    `
											)
											.join("")}
                    
                    <h3 class="subsection-title arabic-text">الأسئلة الرئيسية</h3>
                    <p class="subsection-subtitle arabic-text">أسئلة محددة عنك، هواياتك، تفضيلاتك، إلخ.</p>
                    ${data.personal_information.main_questions
											.map(
												(q) => `
                        <div class="question-item">
                            <button class="tts-button" onclick="speakText('${q.text.replace(
															/'/g,
															"\\'"
														)}', this)" title="Read aloud">🔊</button>
                            <p class="question-text">${q.text}</p>
                        </div>
                    `
											)
											.join("")}
                </section>
            `;

		// Situations Section
		html += `
                <section class="section">
                    <h2>
                        <span class="arabic-text">المواقف</span>
                        <span class="section-timestamp">
                            <button class="timer-button" onclick="toggleTimer('situations', 90)" id="timer-btn-situations">▶</button>
                            <span class="timer-display" id="timer-situations">1:30</span>
                        </span>
                    </h2>
                    <p class="section-subtitle arabic-text">سيناريوهات تفاعلية للمرشح للرد عليها أو بدئها</p>
                    
                    <h3 class="subsection-title arabic-text">مواقف الرد</h3>
                    <p class="subsection-subtitle arabic-text">كيف ترد في السيناريوهات التالية؟</p>
                    ${data.situations.respond_situations
											.map(
												(s) => `
                        <div class="situation-item">
                            <button class="tts-button" onclick="speakText('${(
															s.role_context +
															" " +
															s.starter_line
														).replace(/'/g, "\\'")}', this)" title="Read aloud">🔊</button>
                            <div class="role-context">${s.role_context}</div>
                            <p class="starter-line">"${s.starter_line}"</p>
                        </div>
                    `
											)
											.join("")}
                    
                    <h3 class="subsection-title arabic-text">مواقف السؤال</h3>
                    <p class="subsection-subtitle arabic-text">ماذا تسأل في السيناريوهات التالية؟</p>
                    ${data.situations.ask_situations
											.map(
												(s) => `
                        <div class="situation-item">
                            <button class="tts-button" onclick="speakText('${s.instruction.replace(
															/'/g,
															"\\'"
														)}', this)" title="Read aloud">🔊</button>
                            <div class="role-context">${s.instruction}</div>
                            <p class="starter-line">...?</p>
                        </div>
                    `
											)
											.join("")}
                </section>
            `;

		// Image Section (Section 3)
		html += `
                <section class="section">
                    <h2>
                        <span class="arabic-text">الصورة</span>
                        <span class="section-timestamp">
                            <button class="timer-button" onclick="toggleTimer('image', 90)" id="timer-btn-image">▶</button>
                            <span class="timer-display" id="timer-image">1:30</span>
                        </span>
                    </h2>
                    <p class="section-subtitle arabic-text">سيطرح الممتحن أسئلة حول الصورة، ويمكن للمرشح أيضاً اقتراح أسئلة</p>
                    <div class="exam-image-container">
                        <img id="exam-image" src="" alt="Exam image" class="exam-image" />
                    </div>
                </section>
            `;

		// Listening Script Section (Section 4)
		html += `
                <section class="section">
                    <h2>
                        <span class="arabic-text">نص الاستماع</span>
                        <span class="section-timestamp">
                            <button class="timer-button" onclick="toggleTimer('listening', 120)" id="timer-btn-listening">▶</button>
                            <span class="timer-display" id="timer-listening">2:00</span>
                        </span>
                    </h2>
                    <p class="section-subtitle arabic-text">نص قصير متبوع بأسئلة الفهم</p>
                    
                    <div class="listening-text" style="position: relative;">
                        <button class="tts-button" onclick="speakText('${data.listening_script.text.replace(
													/'/g,
													"\\'"
												)}', this)" title="Read aloud" style="position: absolute; top: 1rem; right: 1rem;">🔊</button>
                        ${data.listening_script.text}
                    </div>
                    
                    <h3 class="subsection-title arabic-text">الأسئلة</h3>
                    <p class="subsection-subtitle arabic-text">أجب على الأسئلة التالية بناءً على النص أعلاه.</p>
                    ${data.listening_script.questions
											.map(
												(q) => `
                        <div class="question-answer" style="position: relative;">
                            <button class="tts-button" onclick="speakText('${q.question.replace(
															/'/g,
															"\\'"
														)}', this)" title="Read aloud" style="position: absolute; top: 0.75rem; right: 0.75rem;">🔊</button>
                            <p class="question-text">${q.question}</p>
                        </div>
                    `
											)
											.join("")}
                </section>
            `;

		// Monologue Section (Section 5)
		html += `
                <section class="section">
                    <h2>
                        <span class="arabic-text">الحديث المنفرد</span>
                        <span class="section-timestamp">
                            <button class="timer-button" onclick="toggleTimer('monologue', 120)" id="timer-btn-monologue">▶</button>
                            <span class="timer-display" id="timer-monologue">2:00</span>
                        </span>
                    </h2>
                    <p class="section-subtitle arabic-text">موضوع للمرشح للتحدث عنه، مع أسئلة متابعة</p>
                    
                    <div class="monologue-topic" style="position: relative;">
                        <button class="tts-button" onclick="speakText('${(
													data.monologue.topic + " for 30 seconds"
												).replace(
													/'/g,
													"\\'"
												)}', this)" title="Read aloud" style="position: absolute; top: 1rem; right: 1rem; background: rgba(255, 255, 255, 0.3); border-color: white;">🔊</button>
                        ${data.monologue.topic} for 30 seconds
                    </div>
                    
                    <h3 class="subsection-title arabic-text">أسئلة المتابعة</h3>
                    <p class="subsection-subtitle arabic-text">كن مستعدًا للإجابة على هذه الأسئلة حول موضوعك.</p>
                    ${data.monologue.follow_up_questions
											.map(
												(q) => `
                        <div class="question-item">
                            <button class="tts-button" onclick="speakText('${q.question.replace(
															/'/g,
															"\\'"
														)}')" title="Read aloud">🔊</button>
                            <p class="question-text">${q.question}</p>
                        </div>
                    `
											)
											.join("")}
                </section>
            `;

		content.innerHTML = html;

		// Load random image after content is rendered
		getRandomImage()
			.then((imagePath) => {
				const imgElement = document.getElementById("exam-image");
				if (imgElement && imagePath) {
					imgElement.src = imagePath;
					// Remove error handler to prevent infinite retry loop
					// If image fails, it will just not display (better than spamming errors)
					imgElement.onerror = function () {
						// Hide the image container if image fails to load
						const container = this.closest(".exam-image-container");
						if (container) {
							container.style.display = "none";
						}
					};
				} else if (imgElement) {
					// No images found, hide the image container
					const container = imgElement.closest(".exam-image-container");
					if (container) {
						container.style.display = "none";
					}
				}
			})
			.catch((error) => {
				console.error("Error loading image:", error);
				const imgElement = document.getElementById("exam-image");
				if (imgElement) {
					const container = imgElement.closest(".exam-image-container");
					if (container) {
						container.style.display = "none";
					}
				}
			});
	}

	// TTS functionality using Web Speech API
	let currentUtterance = null;
	let currentButton = null;

	function speakText(text, buttonElement) {
		// Stop any currently playing speech
		if (window.speechSynthesis.speaking) {
			window.speechSynthesis.cancel();
			if (currentButton) {
				currentButton.classList.remove("playing");
			}
		}

		// Create new utterance
		const utterance = new SpeechSynthesisUtterance(text);

		// Configure voice settings for quality English TTS
		utterance.lang = "en-US";
		utterance.rate = 0.9; // Slightly slower for clarity
		utterance.pitch = 1;
		utterance.volume = 1;

		// Try to use a high-quality female voice if available
		function setVoice() {
			const voices = window.speechSynthesis.getVoices();

			// Prefer female voices - common female voice names
			const femaleVoiceNames = [
				"Samantha",
				"Victoria",
				"Karen",
				"Fiona",
				"Tessa",
				"Zira",
				"Hazel",
				"Susan",
				"Linda",
				"Female",
				"Google UK English Female",
				"Microsoft Zira",
			];

			// First try to find a preferred female voice
			const preferredFemaleVoices = voices.filter(
				(voice) =>
					voice.lang.startsWith("en") && femaleVoiceNames.some((name) => voice.name.includes(name))
			);

			if (preferredFemaleVoices.length > 0) {
				utterance.voice = preferredFemaleVoices[0];
			} else {
				// Try any female voice (check if voice name suggests female)
				const anyFemaleVoices = voices.filter(
					(voice) =>
						voice.lang.startsWith("en") &&
						(voice.name.toLowerCase().includes("female") ||
							voice.name.toLowerCase().includes("samantha") ||
							voice.name.toLowerCase().includes("zira") ||
							voice.name.toLowerCase().includes("victoria") ||
							voice.name.toLowerCase().includes("karen"))
				);

				if (anyFemaleVoices.length > 0) {
					utterance.voice = anyFemaleVoices[0];
				} else {
					// Fallback to any high-quality voice
					const preferredVoices = voices.filter(
						(voice) =>
							voice.lang.startsWith("en") &&
							(voice.name.includes("Google") ||
								voice.name.includes("Microsoft") ||
								voice.name.includes("Samantha") ||
								voice.name.includes("Alex"))
					);

					if (preferredVoices.length > 0) {
						utterance.voice = preferredVoices[0];
					} else {
						// Final fallback to first English voice
						const englishVoices = voices.filter((voice) => voice.lang.startsWith("en"));
						if (englishVoices.length > 0) {
							utterance.voice = englishVoices[0];
						}
					}
				}
			}
		}

		// Set voice (may need to wait for voices to load)
		setVoice();
		if (window.speechSynthesis.getVoices().length === 0) {
			window.speechSynthesis.onvoiceschanged = setVoice;
		}

		// Get button element from event
		currentButton = buttonElement || (window.event ? window.event.target : null);

		// Add visual feedback
		if (currentButton) {
			currentButton.classList.add("playing");
		}

		// Handle speech end
		utterance.onend = function () {
			if (currentButton) {
				currentButton.classList.remove("playing");
			}
			currentUtterance = null;
			currentButton = null;
		};

		utterance.onerror = function () {
			if (currentButton) {
				currentButton.classList.remove("playing");
			}
			currentUtterance = null;
			currentButton = null;
		};

		currentUtterance = utterance;
		window.speechSynthesis.speak(utterance);
	}

	// Load voices when available (some browsers need this)
	if (window.speechSynthesis.onvoiceschanged !== undefined) {
		window.speechSynthesis.onvoiceschanged = function () {
			// Voices loaded
		};
	}

	function toggleTimer(section, totalSeconds) {
		const timer = timers[section];
		const button = event.target;

		if (timer.running) {
			// Pause
			clearInterval(timer.interval);
			timer.running = false;
			button.textContent = "▶";
			button.title = "Resume timer";
		} else {
			// Start/Resume
			timer.running = true;
			button.textContent = "⏸";
			button.title = "Pause timer";

			timer.interval = setInterval(() => {
				timer.remaining--;
				updateTimerDisplay(section);

				// Stop when reaching 0
				if (timer.remaining <= 0) {
					clearInterval(timer.interval);
					timer.running = false;
					timer.remaining = 0;
					button.textContent = "▶";
					button.title = "Start timer";
					updateTimerDisplay(section);

					// Optional: Play a sound or show notification
					if (window.speechSynthesis) {
						const utterance = new SpeechSynthesisUtterance("Time is up");
						utterance.volume = 0.5;
						window.speechSynthesis.speak(utterance);
					}
				}
			}, 1000);
		}

		updateTimerDisplay(section);
	}
</script>

	</body>
</html>
